<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dpmall.db.dao.SalesLeadsOrderDao">
	<resultMap type="com.dpmall.db.bean.SalesLeadsOrderEntity" id="SalesLeadsOrderEntity">
		<result property="id" column="PK"/>
		<result property="clientName" column="P_NAME"/>
		<result property="clientTel" column="P_TELEPHONE"/>
		<result property="clientAddr" column="P_CUSADDRESS"/>
		<result property="clientRemark" column="P_COMMENT"/>
		<result property="serviceAddress" column="P_SERVERADDRESS"/>
		<result property="serviceCatelog" column="P_SERVERPURPOSE"/>
		<result property="serviceTitle" column="P_SERVICETITLE"/>
		<result property="serviceDate" column="P_FITMENTDATE"/>
		<result property="style" column="P_STYLEPREFERENCE"/>
		<result property="budget" column="P_BUDGET"/>
		<result property="brand" column="P_BRANDPREFERENCE"/>
		<result property="callServiceRemark" column="P_HANDLERCOMMENT"/>
		<result property="saleLeadsStatus" column="P_SALESLEADSORDERSTATUS"/>
		<result property="distributeTime" column="P_DISTRIBUTEDATE"/>
		<result property="distributorId" column="P_DISTRIBUTER"/>
		<result property="distributorOperateTime" column="P_AGENCYOPERATEDATE"/>
		<result property="distributorUserName" column="P_AGENCYACCEPT"/>
		<result property="recommendstoreId" column="P_SUGGESTSTORE"/>
		<result property="recommendstoreName" column="P_RECOMMENDSTORENAME"/>
		<result property="storeAcceptTime" column="P_ACCEPTDATE"/>
		<result property="appointmentTime" column="P_APPOINTMENTDATE"/>
		<result property="closeTime" column="P_CLOSEDATE"/>
		<result property="total" column="P_AMOUNT"/>
	</resultMap>
		<select id="getOnePage4Distribute"  resultMap="SalesLeadsOrderEntity">
		select 
			PK,
			P_SALESLEADS,
			P_AGENCY,
			P_SALESLEADSORDERSTATUS,
			P_RESOLVED,
			P_DISTRIBUTEDATE,
			P_DISTRIBUTER,
			P_AGENCYACCEPTDATE,
			P_AGENCYACCEPT,
			P_REFUSEDATE,
			P_SUGGESTSTORE,
			P_ACCEPTSTORE,
			P_ACCEPTRECEIVEDBY,
			P_ACCEPTDATE,
			P_APPOINTMENTDATE,
			P_ACTUALDATE,
			P_AMOUNT,
			P_ORDERPICTURE,
			P_TELEPHONE,
			P_NAME,
			P_FITMENTDATE,
			P_STYLEPREFERENCE,
			P_COMMENT,
			P_BRANDPREFERENCE,
			P_BUDGET,
			P_HANDLER,
			P_HANDLERCOMMENT,
			P_CLOSEDATE,
			P_CLOSEREASON,
			ROWNUM RN
		from SALESLEADSORDER where 1= 1 AND P_SALESLEADSORDERSTATUS='0'
		<if test="agency != null">
		    AND P_DISTRIBUTER = ${agency} 
		</if>
		AND  ROWNUM between ${startNum} and ${pageSize}
	</select>
	
	<select id="getOnePage4Followup"  resultMap="SalesLeadsOrderEntity">
		select 
			PK,
			P_SALESLEADS,
			P_AGENCY,
			P_SALESLEADSORDERSTATUS,
			P_RESOLVED,
			P_DISTRIBUTEDATE,
			P_DISTRIBUTER,
			P_AGENCYACCEPTDATE,
			P_AGENCYACCEPT,
			P_REFUSEDATE,
			P_SUGGESTSTORE,
			P_ACCEPTSTORE,
			P_ACCEPTRECEIVEDBY,
			P_ACCEPTDATE,
			P_APPOINTMENTDATE,
			P_ACTUALDATE,
			P_AMOUNT,
			P_ORDERPICTURE,
			P_TELEPHONE,
			P_NAME,
			P_FITMENTDATE,
			P_STYLEPREFERENCE,
			P_COMMENT,
			P_BRANDPREFERENCE,
			P_BUDGET,
			P_HANDLER,
			P_HANDLERCOMMENT,
			P_CLOSEDATE,
			P_CLOSEREASON,
			ROWNUM RN
		from SALESLEADSORDER where 1= 1 AND P_SALESLEADSORDERSTATUS='10' or P_SALESLEADSORDERSTATUS='15' or P_SALESLEADSORDERSTATUS='20'
		<if test="distributorId != null">
		    AND P_DISTRIBUTER = ${distributorId} 
		</if>
		AND  ROWNUM between ${startNum} and ${pageSize}
	</select>
	
	<select id="get2DistributeCount" resultType="int">
		select count(*) from SALESLEADSORDER  where P_SALESLEADSORDERSTATUS='0'
		<if test="distributorId != null">
				and P_DISTRIBUTER = ${distributorId}
		</if>
	</select>
	
	<select id="getOnePage4Accept"  resultMap="SalesLeadsOrderEntity">
		select 
			PK,
			P_SALESLEADS,
			P_AGENCY,
			P_SALESLEADSORDERSTATUS,
			P_RESOLVED,
			P_DISTRIBUTEDATE,
			P_DISTRIBUTER,
			P_AGENCYACCEPTDATE,
			P_AGENCYACCEPT,
			P_REFUSEDATE,
			P_SUGGESTSTORE,
			P_ACCEPTSTORE,
			P_ACCEPTRECEIVEDBY,
			P_ACCEPTDATE,
			P_APPOINTMENTDATE,
			P_ACTUALDATE,
			P_AMOUNT,
			P_ORDERPICTURE,
			P_TELEPHONE,
			P_NAME,
			P_FITMENTDATE,
			P_STYLEPREFERENCE,
			P_COMMENT,
			P_BRANDPREFERENCE,
			P_BUDGET,
			P_HANDLER,
			P_HANDLERCOMMENT,
			P_CLOSEDATE,
			P_CLOSEREASON,
			ROWNUM RN
		from SALESLEADSORDER where 1= 1 AND P_SALESLEADSORDERSTATUS='10'
		<if test="storeId != null">
		    and P_ACCEPTSTORE=${storeId} 
		</if>
		AND  ROWNUM between ${startNum} and ${pageSize}
	</select>

	<sql id="baseSql">
		SELECT
			S.P_APPOINTMENTDATE,
			S.P_BUDGET,
			S.P_HANDLERCOMMENT,
			S.P_CUSADDRESS,
			S.P_NAME,
			S.P_TELEPHONE,
			S.P_CLOSEDATE,
			S.P_DISTRIBUTEDATE,
			S.P_AGENCY,
			A .P_NAME AS distributorUserName,
			S.PK,
			S.P_SUGGESTSTORE,
			S.P_SALESLEADSORDERSTATUS,
			S.P_FITMENTDATE,
			S.P_SERVERADDRESS,
			S.P_ACCEPTDATE,
			S.P_STYLEPREFERENCE,
			S.P_AMOUNT,
			P_CALLSERVICETEL,
			P_SERVICETITLE,
			P_SERVICECATELOG,
			P_AGENCYOPERATEDATE,
			P_AGENCYACCEPT,
			P_COMMENT					
		FROM
			SALESLEADSORDER S
	</sql>
	
	<select id="getOnePage4Acceptor2Followup" resultMap="SalesLeadsOrderEntity">
			<include refid="baseSql"/>
			left join agency a on s.p_agency = a .pk where 1=1 
			<if test="acceptorId!=null">
				 and s.p_acceptreceivedby=${acceptorId}
			</if>
			<if test="startNum!=null and pageSize!=null">			
				and ${pageSize}*${startNum-1} &lt; rownum and rownum &lt; ${pageSize}*${startNum}+1
			</if>
			
	</select>
	
	<select id="getOnePage4AcceptorClosed" resultMap="SalesLeadsOrderEntity">
		<include refid="baseSql"/>
			left join agency a on s.p_agency = a .pk where 1=1 
		<if test="acceptorId!=null">
			and s.p_acceptreceivedby=${acceptorId}
		</if>
		<if test="startNum!=null and pageSize!=null">			
			and ${pageSize}*${startNum-1} &lt; rownum and rownum &lt; ${pageSize}*${startNum}+1
		</if>
	</select>
	
	<select id="get2AcceptCount" resultType="int">
		select count(1) from SALESLEADSORDER  where P_SALESLEADSORDERSTATUS='10'
		<if test="storeId != null">
		    and P_ACCEPTSTORE=${storeId}
		</if>
	</select>
	
	<update id="distribute">
	    update salesleadsorder set
			p_suggeststore=${shopId},
			p_distributedate=sysdate
		where pk=${saleLeadsId}					
	</update>

</mapper>
